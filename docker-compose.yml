# ============================================================================
# DOCKER COMPOSE КОНФИГУРАЦИЯ ДЛЯ IMAGE HOSTING PROJECT
# ============================================================================
# 
# Этот файл определяет многоконтейнерное приложение, состоящее из:
# - PostgreSQL база данных (db)
# - pgAdmin веб-интерфейс для управления БД (pgadmin)
# - Flask веб-приложение (web)
# - Nginx обратный прокси-сервер (nginx)
#
# Для запуска: docker-compose up -d
# Для остановки: docker-compose down
# ============================================================================

services:
  # ==========================================================================
  # POSTGRESQL DATABASE SERVICE
  # ==========================================================================
  db:
    # Официальный образ PostgreSQL версии 17.5
    image: postgres:17.5
    
    # Имя контейнера для удобства управления
    container_name: image_hosting_db
    
    # Переменные окружения для настройки PostgreSQL
    environment:
      # Основные параметры БД (берутся из .env файла)
      POSTGRES_USER: ${DB_USER}           # Имя пользователя БД
      POSTGRES_PASSWORD: ${DB_PASSWORD}   # Пароль пользователя БД
      POSTGRES_DB: ${DB_NAME}             # Имя создаваемой БД
      
      # Параметры инициализации БД с поддержкой UTF-8
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"
      
      # Настройки локализации для корректной работы с русским текстом
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
      LANGUAGE: en_US.UTF-8
    
    # Проброс портов: хост:контейнер
    ports:
      - "5432:5432"  # Стандартный порт PostgreSQL
    
    # Монтирование томов для постоянного хранения данных
    volumes:
      - db_data:/var/lib/postgresql/data  # Данные БД сохраняются между перезапусками
    
    # Политика перезапуска: перезапускать всегда, кроме ручной остановки
    restart: unless-stopped

  # ==========================================================================
  # PGADMIN WEB INTERFACE SERVICE
  # ==========================================================================
  pgadmin:
    # Официальный образ pgAdmin4 для веб-управления PostgreSQL
    image: dpage/pgadmin4:9.4
    
    # Имя контейнера для удобства управления
    container_name: image_hosting_pgadmin
    
    # Политика перезапуска
    restart: unless-stopped
    
    # Переменные окружения для настройки pgAdmin
    environment:
      # Учетные данные администратора pgAdmin (из .env файла)
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}       # Email для входа
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD} # Пароль для входа
      
      # Настройки безопасности pgAdmin с повышенной защитой
      PGADMIN_CONFIG_SERVER_MODE: 'True'                   # Включаем серверный режим
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'True'      # Требуем мастер-пароль
      PGADMIN_CONFIG_WTF_CSRF_CHECK_DEFAULT: 'True'        # Включаем CSRF защиту

      # Параметры БД для автоматического создания сервера
      DB_PASSWORD: ${DB_PASSWORD}  # Пароль БД для скрипта инициализации
      DB_USER: ${DB_USER}          # Пользователь БД
      DB_NAME: ${DB_NAME}          # Имя БД
    
    # Проброс портов: хост:контейнер
    ports:
      - "5050:80"  # pgAdmin доступен на http://localhost:5050
    
    # Монтирование файлов и томов
    volumes:
      # Конфигурация серверов БД (автоматическое подключение)
      - ./pgadmin_servers.json:/pgadmin4/servers.json:ro
      # Скрипт инициализации для настройки автоматической аутентификации
      - ./init-pgadmin.sh:/docker-entrypoint-initdb.d/init-pgadmin.sh:ro
      # Постоянное хранение настроек pgAdmin
      - pgadmin_data:/var/lib/pgadmin
    
    # Кастомная точка входа для выполнения скрипта инициализации
    entrypoint: ["/bin/bash", "/docker-entrypoint-initdb.d/init-pgadmin.sh", "/entrypoint.sh"]
    
    # Зависимости: pgAdmin запускается после БД
    depends_on:
      - db

  # ==========================================================================
  # FLASK WEB APPLICATION SERVICE
  # ==========================================================================
  web:
    # Сборка образа из локального Dockerfile
    build: .
    
    # Тег образа для идентификации версии приложения
    image: foto-hosting:1.1.73db # Тег версии приложения
    
    # Имя контейнера для удобства управления
    container_name: image_hosting_web
    
    # Проброс портов: хост:контейнер
    ports:
      - "5000:5000"  # Flask приложение доступно на http://localhost:5000
    
    # Монтирование директорий для разработки и хранения данных
    volumes:
      - ./images:/app/images  # Папка с загруженными изображениями
      - ./logs:/app/logs      # Папка с логами приложения
    # Переменные окружения для Flask приложения
    environment:
      # Настройки Flask
      - FLASK_APP=app.py           # Главный файл приложения
      - FLASK_ENV=development      # Режим разработки (включает отладку)
      
      # Параметры подключения к БД (из .env файла)
      - DB_HOST=${DB_HOST}         # Хост БД (имя сервиса 'db')
      - DB_NAME=${DB_NAME}         # Имя базы данных
      - DB_USER=${DB_USER}         # Пользователь БД
      - DB_PASSWORD=${DB_PASSWORD} # Пароль БД
      - DB_PORT=${DB_PORT}         # Порт БД
      
      # Настройки администратора приложения
      - ADMIN_EMAIL=${ADMIN_EMAIL}         # Email главного администратора
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}   # Пароль администратора
      - ADMIN_EMAILS=${ADMIN_EMAILS}       # Список всех администраторов
      - CREATE_ADMIN_USER=${CREATE_ADMIN_USER:-false} # Создавать ли администратора автоматически
      
      # Секретный ключ для безопасности Flask
      - SECRET_KEY=${SECRET_KEY}   # Ключ для подписи сессий и CSRF защиты
    
    # Зависимости: веб-приложение запускается после БД
    depends_on:
      - db
    
    # Политика перезапуска
    restart: unless-stopped

  # ==========================================================================
  # NGINX REVERSE PROXY SERVICE
  # ==========================================================================
  nginx:
    # Официальный образ Nginx
    image: nginx:1.28
    
    # Имя контейнера для удобства управления
    container_name: image_hosting_nginx
    
    # Проброс портов: хост:контейнер
    ports:
      - "8080:80"  # Стандартный HTTP порт, Nginx доступен на http://localhost:8080
    
    # Монтирование конфигурации и статических файлов
    volumes:
      # Кастомная конфигурация Nginx
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Статические изображения (только для чтения)
      - ./images:/app/images:ro
    
    # Зависимости: Nginx запускается после веб-приложения
    depends_on:
      - web
    
    # Политика перезапуска
    restart: unless-stopped

# ============================================================================
# DOCKER VOLUMES (ПОСТОЯННОЕ ХРАНЕНИЕ ДАННЫХ)
# ============================================================================
volumes:
  # Том для хранения загруженных изображений (не используется в текущей конфигурации)
  images_volume:
  
  # Том для хранения логов приложения (не используется в текущей конфигурации)
  logs_volume:
  
  # Том для постоянного хранения данных PostgreSQL
  # Обеспечивает сохранность БД между перезапусками контейнеров
  db_data:
  
  # Том для хранения настроек и конфигурации pgAdmin
  # Сохраняет пользовательские настройки и подключения
  pgadmin_data:

# ============================================================================
# ИНСТРУКЦИИ ПО ИСПОЛЬЗОВАНИЮ
# ============================================================================
#
# 1. Создайте файл .env из .env.example:
#    cp .env.example .env
#
# 2. Отредактируйте .env файл, установив безопасные пароли
#
# 3. Запустите все сервисы:
#    docker-compose up -d
#
# 4. Доступ к сервисам:
#    - Flask приложение: http://localhost:5000
#    - pgAdmin: http://localhost:5050
#    - Nginx: http://localhost:8080
#    - PostgreSQL: localhost:5432
#
# 5. Остановка сервисов:
#    docker-compose down
#
# 6. Полная очистка (включая данные):
#    docker-compose down -v
#
# ============================================================================
