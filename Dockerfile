# ============================================================================
# DOCKERFILE ДЛЯ IMAGE HOSTING PROJECT
# ============================================================================
# 
# Этот Dockerfile создает контейнер для Flask веб-приложения Image Hosting.
# Контейнер включает:
# - Python 3.11 runtime
# - Все необходимые зависимости
# - Gunicorn WSGI сервер для продакшена
# - Предустановленные директории для файлов и логов
# 
# Сборка: docker build -t foto-hosting:latest .
# Запуск: docker run -p 5000:5000 foto-hosting:latest
# 
# ============================================================================

# ============================================================================
# БАЗОВЫЙ ОБРАЗ
# ============================================================================
# Используем официальный Python 3.11 slim образ
# slim версия содержит только необходимые компоненты, что уменьшает размер
# Python 3.11 обеспечивает совместимость с современными библиотеками
FROM python:3.11-slim

# ============================================================================
# НАСТРОЙКА РАБОЧЕЙ ДИРЕКТОРИИ
# ============================================================================
# Устанавливаем рабочую директорию внутри контейнера
# Все последующие команды будут выполняться относительно /app
WORKDIR /app

# ============================================================================
# УСТАНОВКА ЗАВИСИМОСТЕЙ
# ============================================================================
# Копируем файл зависимостей первым для оптимизации кэширования Docker
# Если requirements.txt не изменился, Docker использует кэшированный слой
COPY requirements.txt .

# Устанавливаем Python зависимости
# --no-cache-dir: не сохраняем кэш pip для уменьшения размера образа
# -r requirements.txt: устанавливаем все пакеты из файла
RUN pip install --no-cache-dir -r requirements.txt

# ============================================================================
# КОПИРОВАНИЕ ИСХОДНОГО КОДА
# ============================================================================
# Копируем весь исходный код приложения в контейнер
# Выполняется после установки зависимостей для оптимизации кэширования
COPY . .

# ============================================================================
# СОЗДАНИЕ НЕОБХОДИМЫХ ДИРЕКТОРИЙ
# ============================================================================
# Создаем директории для хранения данных приложения:
# /app/images - для загруженных пользователями изображений
# /app/logs - для файлов логирования приложения
# -p флаг создает родительские директории при необходимости
RUN mkdir -p /app/images /app/logs

# ============================================================================
# НАСТРОЙКА СЕТИ
# ============================================================================
# Открываем порт 5000 для внешних подключений
# Этот порт используется Flask/Gunicorn сервером
# В docker-compose.yml этот порт маппится на хост
EXPOSE 5000

# ============================================================================
# КОМАНДА ЗАПУСКА
# ============================================================================
# Запускаем приложение через Gunicorn WSGI сервер
# Параметры:
# --bind 0.0.0.0:5000 - слушаем на всех интерфейсах порт 5000
# app:app - модуль:переменная (файл app.py, переменная app)
# 
# Gunicorn обеспечивает:
# - Лучшую производительность по сравнению с встроенным сервером Flask
# - Поддержку множественных worker процессов
# - Стабильность в продакшн окружении
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "app:app"]