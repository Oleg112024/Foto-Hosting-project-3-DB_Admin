<!-- 
============================================================================
ШАБЛОН РЕЗУЛЬТАТОВ МНОЖЕСТВЕННОЙ ЗАГРУЗКИ - BATCH ОПЕРАЦИИ
============================================================================

Этот шаблон отображает результаты множественной загрузки изображений,
предоставляя детальную информацию о каждом файле и обработке ошибок.
Поддерживает как успешные загрузки, так и отображение неудачных попыток.

Основные функции:
- Отображение результатов batch загрузки файлов
- Карточки для каждого успешно загруженного изображения
- Таблица ошибок для неудачных загрузок
- Превью изображений с метаданными
- Действия с каждым файлом (просмотр, скачивание, копирование)
- JavaScript функциональность копирования ссылок
- Навигационные элементы для продолжения работы

Технические особенности:
- Наследует базовый шаблон для консистентности
- Использует Bootstrap Grid для адаптивного отображения
- Jinja2 циклы для обработки массивов файлов
- Условная логика для разделения успехов и ошибок
- Clipboard API для копирования ссылок
- Responsive карточки для различных экранов

Пользовательский опыт:
- Четкое разделение успешных и неудачных загрузок
- Визуальная обратная связь для каждого результата
- Немедленный доступ к загруженным файлам
- Понятное объяснение ошибок загрузки
- Множественные варианты дальнейших действий

Обработка ошибок:
- Отображение конкретных причин неудач
- Сохранение информации об оригинальных именах файлов
- Цветовое кодирование для быстрого восприятия
- Детальная таблица ошибок для анализа

Интеграция с системой:
- Получает структурированные данные от Flask route
- Обрабатывает массивы успешных и неудачных файлов
- Использует URL генерацию Flask для ссылок
- Интегрируется с системой управления файлами

Безопасность:
- Отображает только файлы текущего пользователя
- Безопасное формирование URL для изображений
- Экранирование пользовательского контента
- Проверка прав доступа к файлам

============================================================================
-->

<!-- Наследуем базовый шаблон с общей структурой -->
{% extends 'base.html' %}

<!-- Устанавливаем заголовок страницы результатов множественной загрузки -->
{% block title %}Результаты загрузки - Фото Хостинг{% endblock %}

<!-- Основной контент страницы результатов множественной загрузки -->
{% block content %}
<!-- ========================================================================
     ОСНОВНОЙ КОНТЕЙНЕР РЕЗУЛЬТАТОВ МНОЖЕСТВЕННОЙ ЗАГРУЗКИ
     ======================================================================== -->
<div class="container mt-4">
    <!-- Заголовок страницы результатов -->
    <h2 class="mb-4">Результаты загрузки файлов</h2>
    
    <!-- ====================================================================
         FLASH-СООБЩЕНИЯ ДЛЯ СТРАНИЦЫ РЕЗУЛЬТАТОВ МНОЖЕСТВЕННОЙ ЗАГРУЗКИ
         ==================================================================== -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else ('warning' if category == 'warning' else ('info' if category == 'info' else 'success')) }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- ====================================================================
         СЕКЦИЯ УСПЕШНО ЗАГРУЖЕННЫХ ФАЙЛОВ
         Отображение карточек для каждого успешно обработанного изображения
         ==================================================================== -->
    {% if uploaded_files %}
    <!-- Уведомление об успешных загрузках -->
    <div class="alert alert-success" role="alert">
        <h5 class="alert-heading">✅ Успешно загружено: {{ uploaded_files|length }} файлов</h5>
    </div>
    
    <!-- ================================================================
         СЕТКА КАРТОЧЕК УСПЕШНО ЗАГРУЖЕННЫХ ИЗОБРАЖЕНИЙ
         Адаптивное отображение результатов в виде карточек
         ================================================================ -->
    <div class="row">
        {% for file in uploaded_files %}
        <!-- Адаптивная колонка для карточки изображения -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card">
                <!-- ========================================================
                     ЗАГОЛОВОК КАРТОЧКИ
                     Отображение оригинального имени файла
                     ======================================================== -->
                <div class="card-header bg-success text-white">
                    <!-- Оригинальное имя файла от пользователя -->
                    <h6 class="mb-0">{{ file.original_name }}</h6>
                </div>
                
                <!-- ========================================================
                     ТЕЛО КАРТОЧКИ: ПРЕВЬЮ И МЕТАДАННЫЕ
                     ======================================================== -->
                <div class="card-body text-center">
                    <!-- Превью загруженного изображения -->
                    <img src="{{ file.url }}" 
                         alt="{{ file.filename }}" 
                         class="img-fluid mb-3" 
                         style="max-height: 200px;">
                    
                    <!-- Метаданные файла -->
                    <!-- Новое имя файла в системе -->
                    <p><strong>Новое имя:</strong> {{ file.filename }}</p>
                    <!-- Размер файла в килобайтах -->
                    <p><strong>Размер:</strong> {{ "%.2f"|format(file.size / 1024) }} KB</p>
                    
                    <!-- ================================================
                         ПАНЕЛЬ ДЕЙСТВИЙ С ИЗОБРАЖЕНИЕМ
                         Кнопки для операций с загруженным файлом
                         ================================================ -->
                    <div class="btn-group-vertical d-grid gap-2">
                        <!-- Кнопка просмотра в полном размере -->
                        <a href="{{ file.view_url }}" 
                           class="btn btn-sm btn-primary" 
                           target="_blank">Просмотр</a>
                        
                        <!-- Кнопка скачивания с оригинальным именем -->
                        <a href="{{ file.download_url }}" 
                           class="btn btn-sm btn-success" 
                           download="{{ file.original_name }}">Скачать</a>
                        
                        <!-- Кнопка копирования прямой ссылки -->
                        <button class="btn btn-sm btn-outline-primary copy-btn" 
                                data-url="{{ file.url }}">Копировать ссылку</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- ====================================================================
         СЕКЦИЯ ОШИБОК ЗАГРУЗКИ
         Отображение файлов, которые не удалось загрузить
         ==================================================================== -->
    {% if failed_files %}
    <!-- Уведомление об ошибках загрузки -->
    <div class="alert alert-danger" role="alert">
        <h5 class="alert-heading">❌ Ошибки загрузки: {{ failed_files|length }} файлов</h5>
    </div>
    
    <!-- ================================================================
         ТАБЛИЦА ОШИБОК ЗАГРУЗКИ
         Детальная информация о неудачных попытках
         ================================================================ -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Имя файла</th>    <!-- Оригинальное имя проблемного файла -->
                    <th>Ошибка</th>       <!-- Описание причины неудачи -->
                </tr>
            </thead>
            <tbody>
                {% for failed in failed_files %}
                <tr>
                    <!-- Имя файла, который не удалось загрузить -->
                    <td>{{ failed.filename }}</td>
                    <!-- Сообщение об ошибке с красным цветом -->
                    <td class="text-danger">{{ failed.error }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- ====================================================================
         НАВИГАЦИОННЫЕ КНОПКИ
         Варианты дальнейших действий пользователя
         ==================================================================== -->
    <div class="mt-4">
        <!-- Кнопка для загрузки дополнительных файлов -->
        <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
            Загрузить еще файлы
        </a>
        
        <!-- Кнопка перехода к списку всех изображений -->
        <a href="{{ url_for('images_list') }}" class="btn btn-secondary">
            Мои изображения
        </a>
        
        <!-- Кнопка возврата на главную страницу -->
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            На главную
        </a>
    </div>
</div>

<!-- ========================================================================
     JAVASCRIPT ДЛЯ КОПИРОВАНИЯ ССЫЛОК НА ИЗОБРАЖЕНИЯ
     Функциональность копирования URL изображений в буфер обмена
     ======================================================================== -->
<script>
/**
 * Инициализация функциональности копирования ссылок на изображения
 * 
 * Обеспечивает возможность копирования прямых ссылок на загруженные
 * изображения в буфер обмена с визуальной обратной связью.
 * 
 * Особенности:
 * - Использует современный Clipboard API
 * - Предоставляет визуальную обратную связь
 * - Обрабатывает ошибки копирования
 * - Автоматически восстанавливает исходное состояние кнопки
 * - Работает для всех карточек на странице
 */
document.addEventListener('DOMContentLoaded', function() {
    // Находим все кнопки копирования на странице
    const copyButtons = document.querySelectorAll('.copy-btn');
    
    // Добавляем обработчик для каждой кнопки копирования
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Получаем URL изображения из data-атрибута
            const url = this.getAttribute('data-url');
            
            // ========================================================
            // КОПИРОВАНИЕ В БУФЕР ОБМЕНА С ОБРАТНОЙ СВЯЗЬЮ
            // ========================================================
            navigator.clipboard.writeText(url).then(function() {
                // Показываем временное уведомление о копировании
                showTemporaryAlert('Ссылка скопирована в буфер обмена', 'info', 3000);
                
                // Сохраняем оригинальный текст кнопки
                const originalText = button.textContent;
                
                // Временно изменяем внешний вид кнопки для обратной связи
                button.textContent = 'Скопировано!';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success');
                
                // Восстанавливаем исходное состояние через 2 секунды
                setTimeout(function() {
                    button.textContent = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-primary');
                }, 2000);
                
            }).catch(function(err) {
                // ========================================================
                // ОБРАБОТКА ОШИБОК КОПИРОВАНИЯ
                // ========================================================
                
                // Логируем ошибку для отладки
                console.error('Ошибка копирования: ', err);
                
                // Показываем пользователю сообщение об ошибке
                alert('Не удалось скопировать ссылку');
                
                // Возможные причины ошибок:
                // - Браузер не поддерживает Clipboard API
                // - Страница загружена не по HTTPS
                // - Пользователь не дал разрешение на доступ к буферу обмена
            });
        });
    });
});
</script>
{% endblock %}